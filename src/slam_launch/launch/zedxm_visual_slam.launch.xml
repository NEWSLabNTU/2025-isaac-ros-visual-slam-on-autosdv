<?xml version="1.0"?>
<launch>
  <!-- Launch arguments -->
  <arg name="base_frame" default="zedxm_camera_center" description="Base frame for odometry"/>
  <arg name="camera_optical_frames" default="['zedxm_left_camera_optical_frame', 'zedxm_right_camera_optical_frame']" description="List of camera optical frames"/>
  <arg name="start_rviz" default="false" description="Start RViz for visualization"/>
  <arg name="camera_name" default="zedxm" description="Camera name for namespacing"/>

  <!-- Launch ZED X Mini camera node -->
  <include file="$(find-pkg-share zed_wrapper)/launch/zed_camera.launch.py">
    <arg name="camera_model" value="zedxm"/>
    <arg name="camera_name" value="$(var camera_name)"/>
    <arg name="enable_ipc" value="false"/>
  </include>

  <!-- Container with composable nodes -->
  <node_container pkg="rclcpp_components" exec="component_container" name="visual_slam_launch_container" namespace="">

    <!-- Left image format converter -->
    <composable_node pkg="isaac_ros_image_proc" plugin="nvidia::isaac_ros::image_proc::ImageFormatConverterNode" name="image_format_node_left">
      <param name="image_width" value="960"/>
      <param name="image_height" value="600"/>
      <param name="encoding_desired" value="mono8"/>
      <remap from="image_raw" to="/$(var camera_name)/zed_node/left_gray/image_rect_gray"/>
      <remap from="image" to="left/image_rect"/>
    </composable_node>

    <!-- Right image format converter -->
    <composable_node pkg="isaac_ros_image_proc" plugin="nvidia::isaac_ros::image_proc::ImageFormatConverterNode" name="image_format_node_right">
      <param name="image_width" value="960"/>
      <param name="image_height" value="600"/>
      <param name="encoding_desired" value="mono8"/>
      <remap from="image_raw" to="/$(var camera_name)/zed_node/right_gray/image_rect_gray"/>
      <remap from="image" to="right/image_rect"/>
    </composable_node>

    <!-- Visual SLAM node -->
    <composable_node pkg="isaac_ros_visual_slam" plugin="nvidia::isaac_ros::visual_slam::VisualSlamNode" name="visual_slam_node">
      <param name="rectified_images" value="True"/>
      <param name="enable_slam_visualization" value="True"/>
      <param name="enable_landmarks_view" value="True"/>
      <param name="enable_observations_view" value="True"/>
      <param name="camera_optical_frames" value="$(var camera_optical_frames)"/>
      <param name="base_frame" value="$(var base_frame)"/>
      <remap from="/visual_slam/image_0" to="left/image_rect"/>
      <remap from="/visual_slam/camera_info_0" to="/$(var camera_name)/zed_node/left_gray/camera_info"/>
      <remap from="/visual_slam/image_1" to="right/image_rect"/>
      <remap from="/visual_slam/camera_info_1" to="/$(var camera_name)/zed_node/right_gray/camera_info"/>
    </composable_node>

  </node_container>

  <!-- RViz visualization -->
  <node pkg="rviz2" exec="rviz2" name="rviz2" if="$(var start_rviz)"
        args="-d $(find-pkg-share isaac_ros_visual_slam)/rviz/default.cfg.rviz"/>
</launch>
