#!/bin/bash

# Source ROS Humble environment
if [ -f /opt/ros/humble/setup.bash ]; then
    source /opt/ros/humble/setup.bash
else
    echo "WARNING: /opt/ros/humble/setup.bash not found"
    echo "ROS Humble may not be installed. Run: just install-ros"
fi

# Capture project root (directory containing this .envrc)
PROJECT_ROOT="$(pwd)"

export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
export CYCLONEDDS_URI="file://${PROJECT_ROOT}/cyclonedds.xml"

# Check network configuration for DDS (based on Autoware recommendations)
NETWORK_WARNINGS=()

# Check if multicast is enabled on loopback interface
if ! ip link show lo 2>/dev/null | grep -q "MULTICAST"; then
    NETWORK_WARNINGS+=("Multicast is NOT enabled on loopback interface (lo)")
fi

# Check kernel buffer sizes
RMEM_MAX=$(sysctl -n net.core.rmem_max 2>/dev/null || echo "0")
IPFRAG_TIME=$(sysctl -n net.ipv4.ipfrag_time 2>/dev/null || echo "0")
IPFRAG_HIGH=$(sysctl -n net.ipv4.ipfrag_high_thresh 2>/dev/null || echo "0")

if [ "$RMEM_MAX" != "2147483647" ]; then
    NETWORK_WARNINGS+=("net.core.rmem_max is $RMEM_MAX (expected: 2147483647)")
fi

if [ "$IPFRAG_TIME" != "3" ]; then
    NETWORK_WARNINGS+=("net.ipv4.ipfrag_time is $IPFRAG_TIME (expected: 3)")
fi

if [ "$IPFRAG_HIGH" != "134217728" ]; then
    NETWORK_WARNINGS+=("net.ipv4.ipfrag_high_thresh is $IPFRAG_HIGH (expected: 134217728)")
fi

# Display warnings if any
if [ ${#NETWORK_WARNINGS[@]} -gt 0 ]; then
    echo ""
    echo "WARNING: Network configuration issues detected for DDS:"
    for warning in "${NETWORK_WARNINGS[@]}"; do
        echo "  - $warning"
    done
    echo ""
    echo "These settings are required for reliable large data transfers (images, point clouds)."
    echo "See documentation:"
    echo "  - DDS settings: https://autowarefoundation.github.io/autoware-documentation/main/installation/additional-settings-for-developers/network-configuration/dds-settings/"
    echo "  - Multicast setup: https://autowarefoundation.github.io/autoware-documentation/main/installation/additional-settings-for-developers/network-configuration/enable-multicast-for-lo/"
    echo ""
fi
